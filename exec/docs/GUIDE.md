# VAAL 执行任务引导

本文档用于引导 AI 帮助用户执行任务。

---

## 触发方式

当用户说以下话时，表示需要执行任务：
- "帮我执行任务"
- "开始执行"
- "运行任务"

---

## 阶段一：检查准备

### 1.1 检查必要文件

确认以下文件存在：
- `.vaal/_workspace/exec/tasks.md` - 任务列表
- `.vaal/_workspace/exec/config.json` - 配置文件

如果不存在，提示用户：
- tasks.md 不存在：需要先拆分任务，对我说"帮我拆分任务"
- config.json 不存在：需要先初始化，对我说"帮我初始化 VAAL"

### 1.2 确认任务列表

读取 tasks.md，向用户展示：
- 待完成任务数量
- 已完成任务数量
- 第一个待执行的任务

---

## 阶段二：环境预检（质量关口）

> **定位**：预检是 exec 前的最终质量关口。此时所有"原材料"（设计文档、模块、任务、配置）都已就绪，预检负责综合梳理、发现问题、与用户确认后解决。
>
> **本质**：预检是一个需要与用户充分沟通的阶段，用来弥补 init 和 split 阶段可能遗留的问题。

---

### ⛔ 预检阶段的硬性约束

**以下约束必须严格遵守，不允许任何例外：**

1. **必须先读取所有原材料**
   - 在做任何判断或行动之前，必须读取：设计文档、模块定义、任务列表、配置、项目约束、实际目录状态
   - ❌ 禁止：只读取 config.json 就开始行动
   - ❌ 禁止：跳过设计文档直接检查环境

2. **必须先报告再询问**
   - 发现问题后，先完整列出所有问题
   - 然后逐项询问用户的处理方式
   - ❌ 禁止："发现一个问题立即修复"的模式

3. **必须获得用户明确确认才能行动**
   - 任何创建文件、修改配置、安装依赖的操作，必须先获得用户明确确认
   - ❌ 禁止："我认为应该这样做所以做了"
   - ❌ 禁止：用户没有回复就开始执行

4. **行动时必须逐项告知**
   - 每创建一个文件、每修改一个配置，都要明确告诉用户
   - ❌ 禁止：静默修改后只说"已完成"

5. **必须基于设计文档理解架构**
   - 如果需要创建项目骨架，必须读取设计文档中的架构描述
   - ❌ 禁止：用"默认骨架"覆盖设计文档中的架构意图
   - ❌ 禁止：忽略设计文档中"前后端分离"等架构要求

---

### 预检流程（7 步）

#### Step 1：收集原材料（只读取，不判断）

读取以下所有文件，建立全局理解：

| 文件 | 目的 |
|------|------|
| `_workspace/split/design/original.md` | 理解设计意图（架构、技术栈、目录布局） |
| `_workspace/split/modules/*.md` | 理解模块划分（前端/后端归属） |
| `_workspace/exec/tasks.md` | 理解任务列表（有无 INIT 任务、任务起点） |
| `_workspace/exec/config.json` | 理解配置期望（验证命令、git 策略） |
| `_workspace/exec/project-constraints.md` | 理解项目约束（技术栈、硬约束） |
| 项目根目录实际状态 | 是否有 git、package.json、src/ 等 |

**输出格式**：
```
## 原材料收集完成

我已读取以下文件：
- 设计文档：✓（描述了 XXX 架构）
- 模块定义：✓（共 N 个模块）
- 任务列表：✓（共 M 个任务，首个任务是 XXX）
- 配置文件：✓（验证命令：npm test/lint，git 自动提交：开启）
- 项目约束：✓（技术栈：XXX）
- 项目实际状态：✓（git：无，package.json：无）
```

---

#### Step 2：一致性分析（只分析，不行动）

检查各原材料之间是否存在不一致或问题：

| 检查项 | 问题示例 |
|--------|---------|
| 设计文档 ↔ 项目约束 | 设计说"Vue + Node.js"，约束说"Python" |
| 设计文档 ↔ 任务列表 | 设计说"前后端分离"，但没有创建目录结构的任务 |
| 配置 ↔ 实际环境 | 配置要求 `git.autoCommit`，但没有 git 仓库 |
| 配置 ↔ 任务列表 | 配置要求跑 `npm test`，但没有初始化项目的任务 |
| 验证范围 ↔ 项目架构 | 验证命令覆盖的目录是否包含项目架构定义的所有代码目录？ |
| 任务起点 ↔ 项目状态 | 第一个任务是业务逻辑，但项目结构不存在 |

**内部记录所有发现的问题，不在此步输出。**

---

#### Step 3：问题报告（只报告，等待确认）

向用户展示完整的分析结果：

**输出格式**：
```
## 预检报告

### 已理解的项目意图
- 架构：前后端分离（Vue3 + Node.js）
- 目录布局：frontend/, backend/（根据设计文档推断）
- 技术栈：Vue3 + Tailwind (前端), Node.js + SQLite (后端)

### 当前项目状态
- Git 仓库：❌ 不存在
- 项目结构：❌ 不存在（无 package.json）
- 验证命令：⚠️ 无法执行（依赖项目结构）

### 发现的问题

1. ⚠️ **架构落地缺失**
   - 设计文档要求前后端分离
   - 任务列表没有创建项目结构的任务
   - 第一个任务是业务逻辑（TEST-0001-0001）

2. ⚠️ **验证命令无法执行**
   - config 要求 npm test / npm run lint
   - 项目根目录没有 package.json
   - 任务列表没有初始化项目的任务

3. ⚠️ **Git 环境缺失**
   - config 设置 git.autoCommit: true
   - 项目根目录没有 git 仓库

---

**请查看以上问题，我将逐项询问你的处理方式。**
```

---

#### Step 4：逐项询问（交互，收集决策）

对每个问题，提供明确选项让用户选择：

```
### 问题 1：架构落地缺失

设计文档要求前后端分离（Vue3 + Node.js），但任务列表没有初始化任务。

你希望如何处理？
A) 现在创建项目骨架（frontend/, backend/），然后继续执行任务
B) 在任务列表开头添加初始化任务（INIT-0000-*），让执行阶段自动创建
C) 暂不处理，我会手动创建项目结构，创建好了告诉你
D) 其他（请说明）
```

```
### 问题 2：验证命令无法执行

config 要求 npm test，但没有项目结构。

你希望如何处理？
A) 暂时禁用验证（修改 config），等项目结构就绪后手动启用
B) 配合问题 1 的选择，在项目结构创建后验证自动生效
C) 其他（请说明）
```

```
### 问题 3：Git 环境缺失

config 要求 git.autoCommit，但没有 git 仓库。

你希望如何处理？
A) 初始化 git 仓库，将 .vaal 纳入版本管理
B) 初始化 git 仓库，将 .vaal 排除（添加到 .gitignore）
C) 关闭自动提交（修改 config.git.autoCommit = false）
D) 其他（请说明）

（如果选择 A，追问：_workspace 目录是否也纳入 git 管理？）
```

**必须等待用户对所有问题给出回复后，才能进入下一步。**

---

#### Step 5：确认汇总（二次确认）

汇总用户的所有选择，请求最终确认：

```
### 你的选择汇总

| 问题 | 你的选择 |
|------|---------|
| 1. 架构落地 | A - 现在创建 frontend/, backend/ 骨架 |
| 2. 验证命令 | B - 骨架创建后自动生效 |
| 3. Git 环境 | A - 初始化 git，.vaal 纳入管理，_workspace 也纳入 |

---

**确认无误后，我将执行以上操作。**
**请回复"确认"，或告诉我需要修改的地方。**
```

**必须等待用户回复"确认"后，才能执行任何操作。**

---

#### Step 6：执行修复（行动，逐项告知）

根据用户确认的选择执行操作，每一步都明确告知：

```
### 执行中...

✓ 已创建 frontend/ 目录
✓ 已在 frontend/ 初始化 Vue3 项目（使用 create-vue）
✓ 已创建 backend/ 目录
✓ 已在 backend/ 初始化 Node.js 项目（npm init）
✓ 已初始化 git 仓库（git init）
✓ 已创建 .gitignore（含 node_modules, .env, dist 等）
✓ 已创建初始提交："chore: 初始化项目结构"

### 执行完成

所有选择的操作已完成。
```

---

#### Step 7：交接执行（输出命令）

```
### 预检通过 ✓

所有问题已解决，环境已就绪。

请在终端执行以下命令开始执行任务：

node .vaal/exec/scripts/run.js

执行完成后回来告诉我结果，我帮你审查。
```

---

### 预检流程图

```
Step 1: 收集原材料
    │   读取：设计文档、模块、任务、配置、约束、实际状态
    │   输出：收集完成的确认
    ↓
Step 2: 一致性分析
    │   检查所有原材料之间的不一致
    │   内部记录所有问题
    ↓
Step 3: 问题报告
    │   向用户展示所有发现的问题
    │   等待用户确认已阅读
    ↓
Step 4: 逐项询问
    │   对每个问题提供选项
    │   等待用户逐一回复
    ↓
Step 5: 确认汇总
    │   汇总所有选择
    │   等待用户回复"确认"
    ↓
Step 6: 执行修复
    │   根据确认的选择执行
    │   每一步都告知用户
    ↓
Step 7: 交接执行
    │   输出执行命令
    └─→ 进入阶段三
```

---

## 阶段三：执行任务

### 3.1 输出执行命令

> ⚠️ **重要**：不要自己执行这个命令，输出给用户让他们在终端执行。
> 
> 因为执行过程需要多次调用 AI CLI，耗时较长，不适合在对话中等待。

```
准备就绪。请在终端执行以下命令开始执行任务：

node .vaal/exec/scripts/run.js

执行完成后回来告诉我，我帮你审查结果。
```

---

## 阶段四：审查结果

当用户说"执行完了"或"执行完成了"时，进入审查阶段。

### 4.1 读取进度

读取 `.vaal/_workspace/exec/progress.txt`，向用户展示：
- 已完成的任务列表
- 每个任务的执行时间
- 是否有失败的任务

### 4.2 处理失败情况

如果有任务失败：
- 读取失败任务的错误信息
- 帮助用户分析原因
- 可以手动修复后重新执行

### 4.3 后续步骤

全部完成后，提示用户：

```
所有任务已完成。建议你：
1. 审查生成的代码
2. 运行测试确认功能正常
3. 如发现问题，对我说"帮我添加修复任务"
```

---

## 配置参考

`config.json` 关键配置项：

| 配置项 | 说明 |
|--------|------|
| `slots.execute` | AI 执行槽位脚本（`exec/slots/codex.js` / `exec/slots/claude.js` / 自定义） |
| `validation.test` | 测试命令 |
| `validation.lint` | Lint 命令 |
| `git.autoCommit` | 是否自动提交 |

详细配置说明见 [CONFIG.schema.md](./CONFIG.schema.md)。

---

## 注意事项

1. **不要自己执行命令** - 执行过程耗时长，让用户在终端执行
2. **关注失败任务** - 帮助用户理解失败原因
3. **引导代码审查** - 执行完成后提醒用户审查代码
