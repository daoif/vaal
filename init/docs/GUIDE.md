# VAAL 初始化引导

本文档用于引导 AI 完成 VAAL 的初始化配置。

---

## 核心原则

**探查优先，但必须确认。**

AI 应先通过脚本与目录探查获取信息，再通过少量问答把“可执行的最终配置”确定下来。

### 三层配置来源（统一流程）

初始化时，同一份 `config.json` 里的每个关键字段，都来自三层之一：

1. **VAAL 默认值（保底）**：脚本探查不到时的预设值
2. **脚本探查值（更可信）**：由 `setup.js` 自动探查并写入
3. **用户确认值（最终）**：通过问答明确后写回配置

理解这个结构很重要：
- **空仓库**：探查值几乎为空，默认值只用于“给你选项/参考”，不能当成最终结论
- **已有项目**：探查值通常更接近真实情况，问答以“确认/补缺”为主

---

## 初始化流程

### Step 1: 运行初始化脚本

```bash
node .vaal/init/scripts/setup.js
```

脚本会自动：
1. 探查仓库状态（技术栈、源码结构）
3. 创建 `_workspace/` 目录结构
4. 生成 `config.json` 配置草案（默认值 + 探查值）
5. 输出探查报告与下一步提示

---

### Step 2: 问答确认并写回配置（必做）

无论探查到什么，AI 都需要进行一次“少量问答”，把最终配置确定下来。

#### 2.1 先展示当前草案（默认值 + 探查值）

AI 应读取并展示 `.vaal/_workspace/exec/config.json` 中与初始化最相关的内容，尤其是：
- `_probe`（探查结果）
- `slots.execute`（AI 工具）
- `validation.test` / `validation.lint` / `validation.required`（验证策略）
- `git.autoCommit` / `git.autoPush`（Git 策略）

展示时要说清楚“这是草案”，并明确哪些是探查到的，哪些是默认值。

#### 2.2 用最少的问题确认“决定性信息”

目标是**不烦**，但也要把后续会频繁踩坑的点一次说清楚。推荐只问 3–5 个问题：

1. **AI 工具选择（必须问）**
   - 你希望用 `codex` 还是 `claude`？

2. **技术栈/语言（探查不到时必须问）**
   - 如果 `_probe.techStack` 为空：你打算用什么技术栈？（给 3–5 个常见选项 + “其他”）
   - 如果探查到了：我检测到是 X，你确认吗？

3. **验证命令（尽量一次确定）**
   - 如果探查到了 `test/lint`：是否按当前命令执行？哪些是“必须通过”的？
   - 如果没探查到：目前是否已有测试/检查命令？没有的话先留空也可以

4. **Git 策略（按你偏好）**
   - 是否希望任务完成后自动 `commit`？是否自动 `push`？
   - 如果项目还不是 Git 仓库：是否计划使用 Git（例如后续会 `git init`）？

#### 2.3 写回配置并让用户确认

AI 根据回答修改 `.vaal/_workspace/exec/config.json`，然后用一句话总结最终选择，让用户确认即可。

---

### Step 3: 初始化完成的定义（对齐体感）

当且仅当完成以下两件事，才算“初始化完成”：
1. `setup.js` 已生成工作区与配置草案
2. 已完成问答确认，并把最终选择写回 `config.json`

接下来（不属于初始化本身）通常是：
- 写/补设计文档，然后拆分任务
- 或直接编写任务列表并运行执行器

---

## 仓库类型判断标准

> 类型只用于提示“探查到什么程度”，不再用于分叉流程。

| 类型 | 特征 |
|------|------|
| **Type A：空仓库** | 无文件或仅有 README |
| **Type B：文档阶段** | 有 docs/ 目录但无 src/、无 package.json |
| **Type C：骨架阶段** | 有 package.json 但无 Git 提交历史 |
| **Type D：开发中** | 有 Git 提交历史 |

---

## 触发方式

当用户说以下话时，运行初始化：
- "初始化 VAAL"
- "帮我配置 VAAL"
- "读取 .vaal/init/docs/GUIDE.md"

---

## 注意事项

1. **先运行脚本** - 确保 setup.js 已运行，探查已完成
2. **不要假设** - 如果探查失败才询问用户
3. **提供默认值** - 让用户可以快速确认或跳过
4. **确认配置** - 修改配置前让用户确认

---

## 关联文档

- [拆分引导](../../split/docs/GUIDE.md) - 任务拆分引导
- [约束格式](../../split/docs/CONSTRAINT.schema.md) - 约束集结构
- [配置说明](../../exec/docs/CONFIG.schema.md) - 配置项说明
- [使用指南](../../exec/docs/USAGE.md) - 使用指南
