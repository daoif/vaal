# VAAL 任务拆分引导

本文档用于引导 AI 将设计文档拆分为可执行的任务列表。

---

## 触发方式

当用户说以下话时，表示需要进行任务拆分：
- "帮我拆分任务"
- "拆分这个设计文档"
- "从设计文档生成任务"
- "读取 .vaal/docs/SPLIT.guide.md"

---

## 拆分流程

### Step 1: 获取设计文档

```
请提供你的设计文档。你可以：
1. 直接粘贴文档内容
2. 告诉我文档路径，我来读取
3. 描述你想要实现的功能，我帮你整理

设计文档应该包含：
- 功能需求描述
- 技术方案（如有）
- 接口/数据结构定义（如有）
```

---

### Step 2: 存档设计文档

将设计文档保存到 `.vaal/design/` 目录：

```
.vaal/design/
├── original.md          # 原始设计文档
├── modules/             # 拆分后的模块
└── tasks/               # 生成的任务
```

---

### Step 3: 文档 → 模块拆分

将设计文档拆分为独立模块，每个模块包含：

```markdown
# 模块名称

## 概述
简要描述模块功能

## 约束集

### 硬约束（必须满足）
- 约束1
- 约束2

### 软约束（建议满足）
- 约束1

### 依赖（前置条件）
- 依赖模块1
- 依赖模块2

### 风险（注意事项）
- 风险点1

## 检查清单
- [ ] 检查项1
- [ ] 检查项2
```

**拆分原则：**
- 每个模块应该独立可测试
- 模块间依赖关系清晰
- 粒度适中，不要太大也不要太碎

---

### Step 4: 模块 → 测试任务

为每个模块生成测试任务：

```markdown
## 测试任务

- [ ] [TEST] 模块A - 测试正常流程
- [ ] [TEST] 模块A - 测试边界条件
- [ ] [TEST] 模块A - 测试错误处理
```

**原则：**
- 测试任务先于实现任务
- 每个测试应该有明确的预期结果

---

### Step 5: 模块 → 实现任务

为每个模块生成实现任务，附带约束：

```markdown
## 实现任务

- [ ] [IMPL] 模块A - 实现核心逻辑
  - 硬约束: 必须使用 async/await
  - 依赖: 模块B 已完成
  
- [ ] [IMPL] 模块A - 添加错误处理
  - 软约束: 建议使用自定义错误类
```

---

### Step 6: 依赖排序

分析任务间的依赖关系，确定执行顺序：

```
执行顺序：
1. 模块B（无依赖）
2. 模块A（依赖 B）
3. 模块C（依赖 A, B）

依赖图：
B → A → C
    ↗
```

---

### Step 7: 相关任务合并

合并可以一起完成的任务，减少 AI 调用次数：

```
合并前：
- [ ] 创建 User 模型
- [ ] 添加 User 验证

合并后：
- [ ] 创建 User 模型并添加验证
```

**合并原则：**
- 只合并紧密相关的任务
- 合并后仍然可以在单个会话中完成
- 不破坏依赖关系

---

### Step 8: 一致性检查 1

检查任务是否覆盖所有模块：

```
一致性检查报告：

✅ 模块 A: 3 个测试任务, 2 个实现任务
✅ 模块 B: 2 个测试任务, 1 个实现任务
⚠️ 模块 C: 0 个测试任务 ← 缺失测试
```

---

### Step 9: 生成用户故事

从模块提炼用户故事：

```markdown
## 用户故事

### US-001: 用户注册
作为新用户，我希望能够注册账号，以便使用系统功能。

验收标准：
- [ ] 可以输入用户名和密码
- [ ] 密码有强度验证
- [ ] 注册成功后跳转到登录页
```

---

### Step 10: 一致性检查 2

检查用户故事与设计文档的一致性：

```
对比检查：

设计文档功能点：
1. 用户注册 ✅ 已覆盖 (US-001)
2. 用户登录 ✅ 已覆盖 (US-002)
3. 密码重置 ⚠️ 未覆盖 ← 需要补充

遗漏的功能点：
- 密码重置功能
```

---

### Step 11: 输出差异文档

生成差异文档供用户审批：

```markdown
# 任务拆分审批

## 模块列表
1. 模块A - 用户认证
2. 模块B - 数据存储

## 任务统计
- 测试任务: 8 个
- 实现任务: 12 个
- 总计: 20 个

## 需要确认
1. 模块C 是否需要拆分为更小的模块？
2. 密码重置功能是否包含在本次迭代？

## 差异说明
- 原设计文档未明确 X 功能，已添加
- 原设计文档中 Y 功能过于复杂，已拆分

请确认以上内容是否正确。
```

---

### Step 12: 最终输出

根据用户审批生成最终任务列表：

```markdown
# 任务列表

## 阶段一：基础模块
- [ ] [TEST] 模块B - 单元测试
- [ ] [IMPL] 模块B - 实现

## 阶段二：核心功能
- [ ] [TEST] 模块A - 单元测试
- [ ] [IMPL] 模块A - 实现

## 阶段三：集成
- [ ] [TEST] 集成测试
- [ ] [IMPL] 模块C - 实现
```

保存到 `.vaal/tasks.md`。

---

## 输出文件结构

```
.vaal/
├── design/
│   ├── original.md              # 原始设计文档
│   └── modules/
│       ├── module-a.md          # 模块A详情+约束
│       └── module-b.md          # 模块B详情+约束
├── tasks.md                     # 最终任务列表
└── config.json                  # 配置
```

---

## 注意事项

1. **保持可追溯** - 每个任务应能追溯到设计文档
2. **粒度控制** - 单个任务应能在一个 AI 会话中完成
3. **测试先行** - 测试任务排在实现任务之前
4. **用户确认** - 生成前让用户审批
