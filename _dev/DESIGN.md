# VAAL 设计文档

**V**-**A**I-**A**uto-**L**oop - AI 自动化任务循环工具

---

## 一、项目愿景

### 我们想解决什么问题？

当开发者有一个复杂的功能需求时，通常需要：
1. 手动拆分任务
2. 一个一个地让 AI 执行
3. 每次都要手动验证、提交
4. 出错后手动记录和修复

**VAAL 的目标**：让这个过程自动化，开发者只需要提供设计文档，VAAL 帮你拆分任务并自动循环执行。

---

## 二、完整工作流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户完整使用流程                                 │
└─────────────────────────────────────────────────────────────────────────────┘

Phase 0: 设计（在外部完成）
    ↓
    用户在外部 AI 聊天中完善设计文档
    导出设计文档（Markdown 格式）
    ↓
Phase 1: 安装（每仓库一次）
    ↓
    用户克隆 VAAL 到项目子目录：.vaal/
    ↓
Phase 2: 初始化（每仓库一次）
    ↓
    用户对 AI 说："帮我初始化 VAAL"
    AI 读取 INIT.guide.md，与用户对话：
      - 收集验证命令（test, lint）
      - 收集 Git 策略
      - 收集 AI 工具偏好（codex/claude/自定义）
    AI 生成 config.json
    
    【高级】如果预设不满足需求：
      - 用户可以自己编写子脚本模块
      - 用户可以自己拼接执行脚本
      - exec/slots/ 目录提供独立可复用的功能模块
    ↓
Phase 3: 导入设计 + 拆分任务
    ↓
    用户对 AI 说："帮我拆分任务"
    AI 读取 SPLIT.guide.md，执行 12 步流程：
      1. 获取设计文档
      2. 存档设计文档
      3. 文档 → 模块拆分（含约束集）
      4. 模块 → 测试任务
      5. 模块 → 实现任务
      6. 依赖排序
      7. 相关任务合并
      8. 一致性检查1（任务 ↔ 模块）
      9. 生成用户故事
      10. 一致性检查2（用户故事 ↔ 设计文档）
      11. 输出差异文档，用户审批
      12. 根据审批修改，输出最终任务列表
    ↓
Phase 4: 自动执行任务
    ↓
    用户运行：node .vaal/exec/scripts/run.js
    脚本自动循环：
      1. 读取任务列表
      2. 获取下一个待处理任务
      3. 加载任务约束
      4. 检查依赖是否满足
      5. 调用 AI CLI 执行任务（将约束传递给 AI）
      6. 运行验证命令（test, lint）
      7. 验证通过 → Git commit
      8. 验证失败 → 记录并停止
      9. 更新进度，继续下一个任务
    ↓
Phase 5: 人工复审（循环迭代）
    ↓
    用户审查完成的代码
    发现问题 → 回到 Phase 3 添加修复任务
    确认完成 → 结束
```

---

## 三、核心概念

### 3.1 约束集

每个任务/模块都可以有约束：

| 类型 | 名称 | 说明 | 处理方式 |
|------|------|------|----------|
| 🔴 | 硬约束 | 必须满足 | 验证失败则停止 |
| 🟡 | 软约束 | 建议满足 | 记录警告，继续执行 |
| 🔗 | 依赖 | 前置条件 | 依赖未完成则跳过 |
| ⚠️ | 风险 | 注意事项 | 提示 AI 注意 |

### 3.2 任务格式

任务可以包含约束信息：

```markdown
- [ ] [IMPL-001] 实现用户登录 API
  
  **硬约束:**
  - 密码必须使用 bcrypt 加密
  
  **依赖:**
  - IMPL-000: User 模型
  
  **风险:**
  - 暴力破解攻击
```

### 3.3 槽位调度器架构

**核心理念**：主循环只是脚本调度器，不包含任何业务逻辑。

```javascript
// run.js 约 140 行
for (slot of pipeline.global) await callSlot(slots[slot]);
while (hasMore) {
  for (slot of pipeline.loop) await callSlot(slots[slot]);
}
for (slot of pipeline.finally) await callSlot(slots[slot]);
```

**默认 pipeline：**
```
global:  init → loadTasks
loop:    readNext → loadConstraints → execute → validate → git → markDone
finally: report
```

**扩展方式：**
- 替换槽位：改 slots 指向自己的脚本
- 增加槽位：往 pipeline 数组里加槽位名
- 删除槽位：从数组里移除

---

## 四、文件结构

### 4.1 按功能划分的目录结构

```
.vaal/
├── split/                       # 功能1：拆分任务
│   ├── docs/                    # 拆分相关文档
│   │   ├── GUIDE.md             # 拆分引导（AI 读取）
│   │   └── CONSTRAINT.schema.md # 约束格式说明
│   ├── scripts/                 # 拆分脚本（未来扩展）
│   └── templates/               # 拆分相关模板
│       ├── task.template.md
│       └── constraint.template.md
│
├── exec/                        # 功能2：执行任务
│   ├── docs/                    # 执行相关文档
│   │   ├── GUIDE.md             # 初始化/执行引导
│   │   ├── CONFIG.schema.md     # 配置格式说明
│   │   └── USAGE.md             # 使用指南
│   ├── scripts/                 # 执行脚本
│   │   └── run.js               # 槽位调度器
│   ├── slots/                   # 槽位脚本（可插拔）
│   │   ├── init.js              # 初始化上下文
│   │   ├── load-tasks.js        # 加载任务列表
│   │   ├── read-next.js         # 获取下一个任务
│   │   ├── load-constraints.js  # 加载约束
│   │   ├── codex.js             # 调用 Codex CLI
│   │   ├── claude.js            # 调用 Claude CLI
│   │   ├── validate.js          # 运行验证
│   │   ├── git.js               # Git 提交
│   │   ├── mark-done.js         # 标记完成
│   │   └── report.js            # 输出报告
│   └── templates/               # 执行相关模板
│       └── config.template.json
│
├── _dev/                        # VAAL 本身的开发文档
│   └── DESIGN.md                # 设计文档（本文档）
│
└── _workspace/                  # 运行时目录（动态生成）
    ├── config.json              # 用户配置
    ├── tasks.md                 # 任务列表
    ├── progress.txt             # 进度记录
    └── design/                  # 用户设计文档存档
        ├── original.md
        └── modules/
```

### 4.2 目录分类说明

| 目录 | 类型 | 说明 |
|------|------|------|
| `split/` | 功能模块 | 拆分任务功能，当前主要是文档，未来可能有脚本 |
| `exec/` | 功能模块 | 执行任务功能，包含调度器和槽位脚本 |
| `_dev/` | 开发文档 | VAAL 本身的开发文档，非用户文档 |
| `_workspace/` | 运行时 | 用户项目相关的动态数据 |

---

## 五、用户故事

### US-001: 安装 VAAL

**作为**开发者
**我希望**能快速将 VAAL 安装到我的项目中
**以便**使用自动化任务功能

**验收标准：**
- [ ] 运行一条 git clone 命令即可安装
- [ ] 不需要 npm install，零依赖
- [ ] 安装后可以立即使用

---

### US-002: 初始化配置

**作为**开发者
**我希望**通过与 AI 对话来完成初始化配置
**以便**不需要手动编辑配置文件

**验收标准：**
- [ ] 对 AI 说"初始化 VAAL"即可开始
- [ ] AI 会询问必要信息（验证命令、Git 策略等）
- [ ] AI 自动生成 config.json
- [ ] 过程中可以跳过某些配置，使用默认值

---

### US-003: 导入设计文档

**作为**开发者
**我希望**能将设计文档导入 VAAL
**以便**后续自动拆分任务

**验收标准：**
- [ ] 可以直接粘贴文档内容
- [ ] 可以指定文档路径让 AI 读取
- [ ] 设计文档会被存档到 .vaal/_workspace/design/

---

### US-004: 自动拆分任务

**作为**开发者
**我希望**AI 能自动将设计文档拆分为任务列表
**以便**我不需要手动拆分

**验收标准：**
- [ ] AI 按 12 步流程拆分
- [ ] 每个任务都有约束信息
- [ ] 任务按依赖关系排序
- [ ] 生成前需要我确认/审批
- [ ] 可以根据我的反馈修改

---

### US-005: 自动执行任务

**作为**开发者
**我希望**运行一个命令就能自动循环执行所有任务
**以便**我可以去做其他事情

**验收标准：**
- [ ] 运行 `node .vaal/exec/scripts/run.js` 开始执行
- [ ] 自动检查依赖，跳过依赖未完成的任务
- [ ] 自动将约束传递给 AI
- [ ] 每个任务完成后自动运行验证
- [ ] 验证通过自动 Git commit
- [ ] 验证失败停止并记录错误
- [ ] 可以中断后从上次位置继续

---

### US-006: 查看执行进度

**作为**开发者
**我希望**能查看任务执行进度和历史
**以便**了解当前状态

**验收标准：**
- [ ] 执行时控制台显示进度
- [ ] progress.txt 记录执行历史
- [ ] 完成后输出总结报告

---

### US-007: 自定义扩展（高级）

**作为**高级用户
**我希望**能自己编写槽位脚本或调整执行流程
**以便**满足预设之外的特殊需求

**验收标准：**
- [ ] exec/slots/ 目录的每个槽位脚本独立可用
- [ ] 我可以替换任意槽位（改 config 中 slots 指向）
- [ ] 我可以添加自己的槽位脚本
- [ ] 我可以修改 pipeline 数组调整执行顺序
- [ ] 我可以删除不需要的槽位（如不需要 Git）

**示例场景：**
1. 使用 Gemini CLI → 写 `exec/slots/gemini.js`，slots.execute 指向它
2. 需要特殊验证 → 写 `exec/slots/my-validate.js`，slots.validate 指向它
3. 增加通知功能 → 写 `exec/slots/notify.js`，在 pipeline.loop 里加 "notify"
4. 不需要 Git → 从 pipeline.loop 里删除 "git"

---

## 六、约束与限制

### 技术约束
- 零 npm 依赖，只使用 Node.js 内置模块
- 脚本语言：JavaScript

### AI CLI 调用规范

**关键：能调用 ≠ 能全自动执行**

不同 AI CLI 需要不同的参数才能实现全自动执行：

| 工具 | 全自动命令 | 说明 |
|------|-----------|------|
| Codex | `codex exec --skip-git-repo-check --yolo "prompt"` | `--yolo` 跳过确认 |
| Claude | `claude --dangerously-skip-permissions "prompt"` | 跳过权限确认 |
| 自定义 | `{tool} "prompt"` 或使用 `{prompt}` 占位符 | 用户自行配置 |

在 `config.json` 中配置：
```json
{
  "execution": {
    "tool": "codex",           // 使用预设
    // 或
    "tool": "my-ai --auto {prompt}"  // 自定义命令
  }
}
```

### 前提条件
- 用户需要安装 Node.js
- 用户需要安装 Git
- 用户需要安装 AI CLI 工具（codex/claude 等）

### 范围限制
- VAAL 不负责设计（由用户在外部完成）
- VAAL 不负责代码审查（由用户人工完成）
- VAAL 只是自动化"执行任务 → 验证 → 提交"的循环

---

## 七、待确认问题

> 请用户确认以下问题，以便我调整实现：

1. **任务拆分是否必须是 AI 对话式？还是可以提供一个脚本半自动化？**

2. **约束的验证是否只依赖 test/lint 命令？还是需要更细粒度的检查？**

3. **执行任务时，AI CLI 的调用方式是否正确？（当前是简单的命令行调用）**

4. **还有哪些不符合预期的地方？请具体指出。**
